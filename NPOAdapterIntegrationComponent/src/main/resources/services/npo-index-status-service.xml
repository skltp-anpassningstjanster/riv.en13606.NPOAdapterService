<?xml version="1.0" encoding="utf-8"?>
<mule
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:cxf="http://www.mulesoft.org/schema/mule/cxf"
        xmlns="http://www.mulesoft.org/schema/mule/core"
        xmlns:jms="http://www.mulesoft.org/schema/mule/jms"
        xmlns:https="http://www.mulesoft.org/schema/mule/https"
        xsi:schemaLocation="
                http://www.mulesoft.org/schema/mule/core    http://www.mulesoft.org/schema/mule/core/current/mule.xsd
                http://www.mulesoft.org/schema/mule/cxf     http://www.mulesoft.org/schema/mule/cxf/current/mule-cxf.xsd
                http://www.mulesoft.org/schema/mule/jms     http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd
                http://www.mulesoft.org/schema/mule/https   http://www.mulesoft.org/schema/mule/https/current/mule-https.xsd
        ">

    <!--
    Reads NPO send index messages from the JMS queue, and invokes a either a SendStatus operation or forwards
    the message to NPO, see config flag FORWARD_INDEX_TO_NPO.
    -->
    <flow name="SendStatus-1.1.2-Async-Client">

        <jms:inbound-endpoint
                connector-ref="soitoolkit-jms-connector"
                queue="${NPO_INDEX_QUEUE}" >
            <jms:transaction action="ALWAYS_BEGIN" />
        </jms:inbound-endpoint>

        <transformer ref="send-index-transformer" />

        <choice>
            <when expression="${FORWARD_INDEX_TO_NPO} == 'true'">
                <logger level="INFO" message="========= Forward Index To NPO ===========" />

                <https:outbound-endpoint connector-ref="soitoolkit-https-connector"
                                        address="${ENDPOINT_NPO_OUTBOUND_STUB}"
                                        exchange-pattern="request-response"
                                        responseTimeout="${SERVICE_TIMEOUT_MS}"
                                        responseTransformer-refs="check-response-transformer">
                    <cxf:jaxws-client port="NPOSoap"
                                      operation="SendSimpleIndex"
                                      clientClass="se.nationellpatientoversikt.NPO"
                                      wsdlLocation="classpath:/interactions/npo/NPO_1.1.2.wsdl" />
                </https:outbound-endpoint>
            </when>
            <otherwise>
                <logger level="INFO" message="========= Send Status Update to Care System ===========" />
                <cxf:proxy-client payload="body" />
                <processor ref="route-processor" />
                <object-to-string-transformer encoding="UTF-8" />
                <transformer ref="check-response-transformer" />
            </otherwise>
        </choice>


        <custom-exception-strategy class="org.soitoolkit.commons.mule.error.ServiceExceptionStrategy"/>
    </flow>

</mule>
